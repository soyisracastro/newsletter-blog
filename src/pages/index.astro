---
import Layout from '../layouts/Layout.astro';
import { AudioLines } from '@lucide/astro';
import { PUBLIC_SENDY_LIST_ID, PUBLIC_SENDY_ACTION_URL, PUBLIC_SENDY_API_KEY } from 'astro:env/client';

const listId = PUBLIC_SENDY_LIST_ID;
const actionUrl = PUBLIC_SENDY_ACTION_URL;
const formId = 'entra-sendy-form';
---

<Layout title="Newsletter Fiscal - TodoConta" description="Únete a la newsletter fiscal y recibe contenido directo para contadores y administrativos.">
  <main id="main-content" class="max-w-2xl mx-auto px-6 pb-20 pt-16">
    <!-- Page Heading -->
    <div class="flex flex-col gap-8 py-2 md:py-4">
      <h1 class="tape-title text-4xl md:text-5xl mx-auto">
        Newsletter Fiscal
      </h1>
      <div class="flex flex-col gap-4 text-center">
        <p class="text-neutral-800 text-lg leading-relaxed">Cada semana te mando un email.</p>
        <p class="text-neutral-800 text-lg leading-relaxed">A veces sobre el SAT.</p>
        <p class="text-neutral-800 text-lg leading-relaxed">A veces sobre Excel, IA, Software.</p>
        <p class="text-neutral-800 text-lg leading-relaxed">A veces sobre cómo cobrar más.</p>
      </div>
      <!-- Emphasis Text -->
      <p class="text-neutral-500 text-lg italic leading-relaxed pt-4 text-center">
        No es motivación barata ni tips genéricos. Es contenido directo para contadores y administrativos que quieren dejar de perder tiempo en tareas que se pueden automatizar.
      </p>
    </div>

    <!-- Lead Magnet Card -->
    <div class="mt-8 mb-8 group">
      <div class="relative overflow-hidden flex flex-col items-stretch justify-start rounded-sm shadow-lg bg-[#111] text-white p-10 md:p-16">
        <!-- Decorative Waveform SVG -->
        <div class="absolute right-0 top-0 opacity-10 pointer-events-none">
          <svg fill="none" height="200" viewBox="0 0 200 200" width="200" xmlns="http://www.w3.org/2000/svg">
            <rect fill="white" height="40" rx="4" width="8" x="20" y="80"></rect>
            <rect fill="white" height="80" rx="4" width="8" x="40" y="60"></rect>
            <rect fill="white" height="20" rx="4" width="8" x="60" y="90"></rect>
            <rect fill="white" height="60" rx="4" width="8" x="80" y="70"></rect>
            <rect fill="white" height="100" rx="4" width="8" x="100" y="50"></rect>
            <rect fill="white" height="40" rx="4" width="8" x="120" y="80"></rect>
            <rect fill="white" height="70" rx="4" width="8" x="140" y="65"></rect>
            <rect fill="white" height="20" rx="4" width="8" x="160" y="90"></rect>
          </svg>
        </div>
        <div class="relative z-10 flex flex-col gap-6" id="lead-magnet-content">
          <div class="flex items-center gap-3">
            <AudioLines class="w-10 h-10" />
            <p class="font-mono text-xl font-bold leading-tight tracking-tight">
              Regístrate y recibe de inmediato:
            </p>
          </div>
          <p class="text-lg font-medium leading-normal">
            Un audio de 10 minutos donde te cuento los 3 errores que te mantienen cobrando poco <span class="opacity-80 font-normal">(y cómo arreglarlos sin volverte freelancer o dejar tu trabajo).</span>
          </p>
          <div class="pt-2 border-t border-white/20">
            <p class="text-sm font-light opacity-90 italic">Grabado desde mi escritorio. Sin editar. Con una taza de café.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Subscription Form -->
    <form id={formId} action={actionUrl} method="POST" accept-charset="utf-8" class="flex flex-col gap-6 py-12">
      <div id="form-fields" class="space-y-6">
        <label class="flex flex-col w-full">
          <p class="text-neutral-800 text-base font-semibold leading-normal pb-3 px-1">Tu mejor email</p>
          <input
            name="email"
            id="email"
            class="form-input flex w-full rounded-sm text-neutral-800 focus:outline-0 focus:ring-2 focus:ring-neutral-400 border border-neutral-200 bg-white h-16 px-5 text-lg font-normal placeholder:text-neutral-400"
            placeholder="ejemplo@correo.com"
            required
            type="email"
          />
        </label>

        <!-- Sendy Required Fields -->
        <div class="hidden">
          <input type="hidden" name="list" value={listId} />
          <input type="hidden" name="subscribesubmit" value="true" />
          <input type="hidden" name="boolean" value="true" />

          <!-- Honeypot -->
          <div style="display:none;">
            <label for="hp">HP</label><br/>
            <input type="text" name="hp" id="hp" />
          </div>
        </div>

        <label class="flex items-center gap-3 px-1 cursor-pointer">
          <input class="form-checkbox size-5 rounded-sm border-neutral-200 text-neutral-800 focus:ring-neutral-400" required type="checkbox"/>
          <span class="text-sm text-neutral-500">Acepto recibir emails y la <a href="/privacidad" class="underline hover:text-neutral-800 transition">política de privacidad</a>.</span>
        </label>
      </div>

      <button id="submit-btn" class="tape-title w-full flex cursor-pointer items-center justify-center overflow-hidden rounded-sm h-16 px-8 text-xl leading-normal shadow-lg transition-transform active:scale-[0.98]" type="submit">
        QUIERO EL AUDIO
      </button>

      <div id="message" class="hidden text-sm font-medium p-6 rounded-sm text-center"></div>
    </form>

    <!-- Footer / PD Section -->
    <footer class="mt-24 pt-12 border-t border-neutral-200">
      <div class="flex flex-col gap-4 text-center sm:text-left">
        <p class="text-neutral-500 text-sm leading-relaxed">
          <span class="font-bold">PD:</span> Si crees que ya sabes todo de Excel, IA, o que no necesitas cobrar más, o que el SAT es "fácil", no te suscribas. No tengo nada que enseñarte.
        </p>
      </div>
    </footer>
  </main>

  <script define:vars={{ formId, actionUrl, apiKey: PUBLIC_SENDY_API_KEY }}>
    const SUCCESS_HTML = `
      <div class="w-full max-w-[600px] flex flex-col gap-8 mx-auto">
        <!-- Headline Section -->
        <div class="pt-10">
          <h1 class="font-serif tracking-tight text-4xl font-bold leading-tight text-neutral-800">
            Casi listo. Falta un paso.
          </h1>
        </div>
        <!-- Body Text 1 -->
        <div class="flex flex-col gap-4">
          <p class="text-lg text-neutral-800 leading-relaxed">
            Te acabo de mandar un email. Ve a tu bandeja de entrada (o a spam, por si acaso) y busca un correo mío con el asunto:
          </p>
        </div>
        <!-- Simulated Inbox Row -->
        <div class="p-6 bg-neutral-50 border border-neutral-200 rounded-sm shadow-sm font-sans">
          <div class="flex items-center gap-4">
            <div class="flex-shrink-0 w-10 h-10 bg-neutral-100 rounded-full flex items-center justify-center text-neutral-800">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
            </div>
            <div class="flex flex-col gap-1 overflow-hidden">
              <span class="text-[10px] uppercase tracking-wider text-neutral-400 font-bold">Asunto del correo</span>
              <p class="text-neutral-800 text-base font-medium truncate">
                Confirma que eres tú (y no un bot aburrido)
              </p>
            </div>
          </div>
        </div>
        <!-- Body Text 2 -->
        <div class="flex flex-col gap-4">
          <p class="text-lg text-neutral-800 leading-relaxed">
            Dale clic al enlace que viene ahí dentro.
          </p>
        </div>
        <hr class="border-t border-neutral-200 my-4"/>
        <!-- Explanation Section -->
        <div class="flex flex-col gap-4">
          <h2 class="text-neutral-800 text-xl font-bold tracking-tight">¿Por qué este paso extra?</h2>
          <p class="text-base text-neutral-500 leading-relaxed">
            Este paso asegura que nadie use tu correo sin tu permiso y que mis mensajes lleguen directos a tu bandeja sin perderse en el ruido digital. Es una medida de seguridad y calidad.
          </p>
          <p class="text-base text-neutral-800 font-bold italic">
            Ganamos los dos.
          </p>
        </div>
        <hr class="border-t border-neutral-200 my-4"/>
        <!-- Support Footer -->
        <div class="flex flex-col gap-6 pb-12">
          <div class="flex items-start gap-4">
            <div class="text-neutral-400 flex-shrink-0 mt-0.5">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            </div>
            <p class="text-sm text-neutral-500 leading-normal">
              ¿No encuentras el correo? Revisa la carpeta de "Promociones" o "Correo no deseado". Si en 5 minutos sigue sin aparecer, puedes contactarnos directamente en <a href="mailto:soporte@columna13.club" class="underline hover:text-neutral-800 font-bold transition">soporte@columna13.club</a>
            </p>
          </div>
        </div>
      </div>
    `;

    const setupForm = () => {
      const form = document.getElementById(formId);
      if (!form) return;

      const messageDiv = document.getElementById('message');
      const submitBtn = document.getElementById('submit-btn');
      const mainContent = document.getElementById('main-content');
      const originalBtnContent = submitBtn?.innerHTML;

      if (!messageDiv || !submitBtn || !mainContent) return;
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Clear previous messages
        messageDiv.classList.add('hidden');
        messageDiv.className = 'hidden text-sm font-medium p-6 rounded-sm text-center';

        const formData = new FormData(form);
        const data = new URLSearchParams();

        for (const [key, value] of formData.entries()) {
          data.append(key, value.toString());
        }

        data.append('api_key', apiKey);
        data.append('boolean', 'true');

        // Disable button
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Enviando...';

        try {
          const response = await fetch(actionUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: data,
          });

          const result = await response.text();

          if (result === '1') {
            mainContent.innerHTML = SUCCESS_HTML;
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else if (result === 'Already subscribed.') {
            messageDiv.classList.remove('hidden');
            messageDiv.className = 'text-sm font-medium p-4 rounded-sm text-center bg-neutral-100 text-neutral-800 border border-neutral-200';
            messageDiv.textContent = 'Parece que ya estás en la lista. ¡Revisa tu correo para el acceso!';
          } else {
            messageDiv.classList.remove('hidden');
            messageDiv.className = 'text-sm font-medium p-4 rounded-sm text-center bg-red-50 text-red-800 border border-red-200';
            messageDiv.textContent = `Vaya, algo salió mal: ${result}`;
          }
        } catch (error) {
          messageDiv.classList.remove('hidden');
          messageDiv.className = 'text-sm font-medium p-4 rounded-sm text-center bg-red-50 text-red-800 border border-red-200';
          messageDiv.textContent = 'Hubo un error de conexión. Inténtalo de nuevo más tarde.';
        } finally {
          if (submitBtn && !submitBtn.classList.contains('hidden')) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnContent;
          }
        }
      });
    };

    setupForm();
    document.addEventListener('astro:page-load', setupForm);
  </script>
</Layout>
